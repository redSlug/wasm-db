<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <script src="sqlite3.js"></script>
    </head>
    <body>
        <p>test copy db to local storage</p>
        <script src="save_to_indexeddb.js"></script>
        <script>
            window.sqlite3InitModule().then(function(sqlite3){
                window.sqlite3 = sqlite3;
                function initdb(buffer){
                    window.db = new sqlite3.oo1.DB();
                    console.log(db);
                        sqlite3.capi.sqlite3_deserialize(
                        db.pointer, 'main',
                        sqlite3.wasm.allocFromTypedArray(buffer),
                        buffer.byteLength,
                        buffer.byteLength,
                        sqlite3.capi.SQLITE_DESERIALIZE_FREEONCLOSE
                    );
                };
                fetch("samples.sqlite")
                .then(res => res.arrayBuffer())
                .then(buffer => {initdb(buffer)});
            });

            async function cpDb(){
                // origin private file system root; opfs allows us to do read and write
                // while local storage and indexed only allowed read
                const opfsRoot = await navigator.storage.getDirectory()
                console.log('opfsRoot', opfsRoot);
                console.log('opfsRoot', opfsRoot);

                const directoryHandle = await opfsRoot.getDirectoryHandle("db_folder", {
                    create: true,
                });
                const nestedFileHandle = await directoryHandle.getFileHandle(
                    "dummy_file_db",
                    { create: true },
                );
                console.log('nestedFileHandle', nestedFileHandle);
            };


            function dbExec(){
                let res = [];
                db.exec({
                    sql: "SELECT * FROM samples;",
                    rowMode: 'object',
                    callback: function(row){res.push(row);}
                });
                console.log(res);
            };

            function dbExecCustom(command){
                let res = [];
                db.exec({
                    sql: command,
                    rowMode: 'object',
                    callback: function(row){res.push(row);}
                });
                console.log(res);
            };
        </script>
        <button onclick="cpDb()">Click Me</button>

    </body>
</html>
